# BSPED Paediatric DKA Calculator

A web application for generating individualised versions of the **integrated care pathway for the management of children and young people under the age of 18 years with Diabetic Ketoacidosis** (2021) in line with [BSPED guidance](https://www.bsped.org.uk/clinical-resources/bsped-dka-guidelines/).

The BSPED Paediatric DKA Calculator is registered as a medical device with the MHRA.

All patient identifiable data is processed on the client device. Only anonymised data is transmitted to the server. Exception: postcode is transmitted (encrypted) to the server and used to derive the Index of Multiple Deprivation (IMD) decile, then immediately deleted and is not stored. See the [privacy policy](https://dka-calculator.co.uk/privacy-policy).

## Client application

The client is a single page application served from `https://dka-calculator.co.uk`. It is designed using the Vue 3 JavaScript framework (Composition API). The client application is found in the repository under `src/`. The dependencies are listed in `package.json`. On deployment the application is minified using a build step to improve performance at runtime.

### Views structure

The view files are single-file components (SFCs). The primary view is `src/App.vue` which adds the header and footer components from `src/components/` around the router-view. The views shown by the router-view are found in `src/views/`. The user progression is generally linear:

1. Start / welcome `Start.vue`
2. Legal disclaimer `FormDisclaimer.vue`
3. Patient details `FormPatientDetails.vue`
4. Clinical details `FormClinicalDetails.vue`
5. Weight safety limit override confirmation `FormOverrideConfirm.vue` (only shown if applicable)
6. Audit details `FormAuditDetails.vue`
7. Generating care pathway `GenerateProtocol.vue`

A privacy policy page `PrivacyPolicy.vue` can be accessed outside the usual linear flow.

### Data handling

Data stores are located in `src/assets/`. The data entered is handled by `data.js` which includes the client-side validation checks for the data.

Once the final step of the form is reached the data is transmitted using the method from `api.js` which also deposits the API response into `data.js`.

The PDF care pathway is generated by the `webWorker.js` method which uses `docDef.js`, `imageStore.js`, `data.js` and `config.js` to build the document definition required by the PDFmake library.

## API

The API is served from `https://dka-calculator.co.uk/api` which is found in the repository under `public/api/`. The various functions of the API include validating and performing calculations on the input variables, generating unique episode IDs, inserting audit variables into the SQL database and returning the calculations and episode IDs to the client.

### API calls

The API accepts a POST request with a single parameter "data" as a JSON object with the following properties:

- **legalAgreement** boolean | required | accepted values: `true`
- **patientAge** integer | required | accepted values: integer `>0` and `<=18`
- **patientSex** string | required | accepted values: `male` or `female`
- **patientHash** string | optional | accepted values: SHA-256 output hash
- **patientPostcode** string | optional | accepted values: any valid UK postcode
- **protocolStartDatetime** string | required | accepted values: datetime with format `YYYY-MM-DDTHH:MM`
- **pH** string | required | accepted values: number `>=6.5` and `<7.3`
- **bicarbonate** string | optional | accepted values: number `>=0` and `<15` (if used for severity calculation)
- **glucose** string | optional | accepted values: any number,
- **ketones** string | optional | accepted values: number `>=3` (if provided)
- **weight** string | required | accepted values: any number (but fluid and insulin calculations will be capped as for 75kg patient if value exceeds this)
- **shockPresent** string | required | accepted values: `true` or `false`
- **insulinRate** string | required | accepted values: `0.05` or `0.1`
- **preExistingDiabetes** string | required | accepted values: `true` or `false`
- **insulinDeliveryMethod** string | required (if preExistingDiabetes is `true`) | accepted values: `pen` or `pump`
- **episodeType**: string | required | accepted values: `real` or `test`
- **region** string | required | accepted values: any (expected per list in src/assets/config.js but not validated)
- **centre** string | required | accepted values: any (expected per list in src/assets/config.js but not validated)
- **ethnicGroup** string | required | accepted values: any (expected per list in src/assets/config.js but not validated)
- **ethnicSubgroup** string | required | accepted values: any (expected per list in src/assets/config.js but not validated)
- **preventableFactors** array | required | accepted values: array of minimum length 1 (expected contents of array per list in src/assets/data.js but not validated)
- **weightLimitOverride** boolean | required | accepted values: `true` or `false`
- **appVersion** string | required | accepted values: any (expected per value in src/assets/config.js but not validated)
- **clientDatetime** string | required | accepted values: any (expected client device datetime generated at API call but not validated)
- **clientUseragent** string | required | accepted values: any (expected client navigator.userAgent but not validated)

### API response

The API responds to valid calls with a JSON object with the following properties:

- **auditID** string (the unique episode ID to be printed on the generated care pathway and stored with the audit data)
- **calculations** object:
  - **severity** string | `mild` or `moderate` or `severe`
  - **bolusVolume** object:
    - **val** number (the calculated value for bolus volume)
    - **limit** string (the limit which the calculated value will never exceed)
    - **isCapped** boolean (if the calculated value was capped by the limit)
    - **formula** string (the forumla used to perform the calculation)
    - **working** string (the formula with provided variables and output)
  - **deficit** object:
    - **percentage** object:
      - **val** number (the calculated value for deficit percentage)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
    - **volume** object:
      - **val** number (the calculated value for deficit volume)
      - **limit** string (the limit which the calculated value will never exceed)
      - **isCapped** boolean (if the calculated value was capped by the limit)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
    - **volumeLessBolus** object:
      - **bolusToSubtract** number (the bolus volume to be subtracted from deficit volume to give deficit volume less bolus)
      - **val** number (the calculated value for deficit volume less bolus)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
    - **rate** object:
      - **val** number (the calculated value for deficit rate)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
  - **maintenance** object:
    - **volume** object:
      - **val** number (the calculated value for maintenance volume)
      - **limit** string (the limit which the calculated value will never exceed)
      - **isCapped** boolean (if the calculated value was capped by the limit)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
    - **rate** object:
      - **val** number (the calculated value for maintenance rate)
      - **formula** string (the forumla used to perform the calculation)
      - **working** string (the formula with provided variables and output)
  - **startingFluidRate** object:
    - **val** number (the calculated value for starting fluid rate)
    - **formula** string (the forumla used to perform the calculation)
    - **working** string (the formula with provided variables and output)
  - **insulinRate** object:
    - **val** number (the calculated value for insulin rate)
    - **limit** string (the limit which the calculated value will never exceed)
    - **isCapped** boolean (if the calculated value was capped by the limit)
    - **formula** string (the forumla used to perform the calculation)
    - **working** string (the formula with provided variables and output)
